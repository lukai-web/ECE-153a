#include "xil_io.h"
#include "sleep.h"
#include <stdio.h>
#include "xgpio.h"   // <-- 加入按钮 GPIO 必须包含

#define SEG_BASE_ADDR 0x00010000u

// 按钮 GPIO 宏（你给的）
#define XPAR_AXI_GPIO_BTN_DEVICE_ID 2

XGpio BtnGpio;   // 按钮 GPIO 句柄

// 段码表（低电平有效）
const unsigned char seg_codes[10] = {
    0xC0,0xF9,0xA4,0xB0,0x99,
    0x92,0x82,0xF8,0x80,0x90
};

// 寄存器位位移定义
#define D0_SEG_SHIFT    0
#define D1_SEG_SHIFT    8
#define D0_AN_SHIFT     16
#define D1_AN_SHIFT     20

#define AN_ACTIVE_LOW 1
#define SEG_OFF 0xFFu

static int display_buf[8] = {0};

void update_display_value(int value) {
    for (int i = 7; i >= 0; --i) {
        display_buf[i] = value % 10;
        value /= 10;
    }
}

static inline void write_register_for_scan(int scan_id) {
    unsigned int data = 0;
    unsigned int d0_seg = SEG_OFF;
    unsigned int d1_seg = SEG_OFF;
    unsigned int d0_an_field = AN_ACTIVE_LOW ? 0xFu : 0x0u;
    unsigned int d1_an_field = AN_ACTIVE_LOW ? 0xFu : 0x0u;

    if (scan_id < 4) {
        d0_seg = seg_codes[ display_buf[scan_id] ];
        if (AN_ACTIVE_LOW)
            d0_an_field = (~(1u << scan_id)) & 0xFu;
        else
            d0_an_field = (1u << scan_id);

        d1_seg = SEG_OFF;
    } else {
        int idx = scan_id - 4;
        d1_seg = seg_codes[ display_buf[scan_id] ];
        if (AN_ACTIVE_LOW)
            d1_an_field = (~(1u << idx)) & 0xFu;
        else
            d1_an_field = (1u << idx);

        d0_seg = SEG_OFF;
    }

    data |= (d0_seg << D0_SEG_SHIFT);
    data |= (d1_seg << D1_SEG_SHIFT);
    data |= (d0_an_field << D0_AN_SHIFT);
    data |= (d1_an_field << D1_AN_SHIFT);

    Xil_Out32(SEG_BASE_ADDR, data);
}

int main() {
    int value = 0;
    int scan_id = 0;
    update_display_value(value);

    const unsigned int per_scan_us = 100;
    const unsigned int scans_per_half_sec = (500000u / per_scan_us);
    unsigned int slow_counter = 0;

    //
    // ------------------ 初始化按钮 AXI GPIO ------------------
    //
    int status;
    status = XGpio_Initialize(&BtnGpio, XPAR_AXI_GPIO_BTN_DEVICE_ID);
    if (status != XST_SUCCESS) {
        xil_printf("Button GPIO Init Failed\r\n");
        return XST_FAILURE;
    }

    // 设置为输入方向（通道 1）
    XGpio_SetDataDirection(&BtnGpio, 1, 0xFFFFFFFF);
    xil_printf("Button Ready.\r\n");

    // ----------------------------------------------------------

    while (1) {
        // 数码管刷新
        write_register_for_scan(scan_id);
        scan_id++;
        if (scan_id >= 8) scan_id = 0;

        usleep(per_scan_us);
        slow_counter++;

        //
        // ------------------ 按键轮询：按下 BTN0 → 清零 ------------------
        //
        u32 btn = XGpio_DiscreteRead(&BtnGpio, 1);
        if (btn & 0x01) { 
            value = 0;
            update_display_value(value);
        }
        // ----------------------------------------------------------

        // 半秒加一次数字
        if (slow_counter >= scans_per_half_sec) {
            slow_counter = 0;
            value = (value + 1) % 100000000;
            update_display_value(value);
        }
    }

    return 0;
}
